{% extends "@quick_coding.view/layout/base.html.twig" %}

{% block title %} {{ config.title }} {% endblock %}

{% block stylesheets %}
<link rel="stylesheet" href="{{ asset(quick_coding.public ~ "plugins/datatables/dataTables.uikit.min.css") }}" />
{% endblock %}

{% block javascripts %}
<script src="{{ asset(quick_coding.public ~ "plugins/datatables/jquery.dataTables.min.js") }}"></script>
<script src="{{ asset(quick_coding.public ~ "plugins/datatables/dataTables.uikit.min.js") }}"></script>
<script>
$(document).ready(function(){
	var delID = null;
	var table = $("#view").DataTable({
        processing: true,
        serverSide: true,
        pageLength: 25,
        orderMulti: true,
        ajax: {
            url: "{{ config.path.view is iterable ? path(config.path.view[0], config.path.view[1]) : path(config.path.view) }}",
            data: function(params) {params.type = "json";delete params.columns}
        },
        columns: [
        	{% for item in config.view.select %}
        	{data: "{{ item | replace({' ': ""}) }}", defaultContent: '-', render: function ( data, type, row ) {
            	if(Array.isArray(data)){
                	return (data.map(v => v ? `<span class="uk-label uk-label-success uk-border-rounded item-datatables">${v}</span>` : '')).join('');
                }

                var d = new Date(data);
                if(d instanceof Date && !isNaN(d) && d.getTime() != data){
                    
                	return d.toLocaleString('en', { dateStyle : 'medium', timeStyle: 'short', timeZone: 'UTC' });
                	//return date.toLocaleDateString('en', { dateStyle : 'medium', timeZone: 'UTC' });
                	//return date.toLocaleTimeString('en', { timeStyle: 'short', timeZone: 'UTC' });
                }

                if (typeof data === 'string' || data instanceof String){
                	return data.replace(/(?:\r\n|\r|\n)/g, '<br>');
                }
    	        
                return data;
            }},
            {% endfor %}
        	{data: "remove", width:110, orderable:false, defaultContent: `
            	<button type="button" class="uk-button uk-button-secondary uk-border-rounded uk-button-small qc-btn-action qc-view">
            		<span uk-icon="icon: file-text"></span>
            	</button>
            	{%- if (config.ACL.update|length) == 0 or is_granted(config.ACL.update) -%}
            	<button type="button" class="uk-button uk-button-primary uk-border-rounded uk-button-small qc-btn-action qc-edit">
        			<span uk-icon="icon: file-edit"></span>
        		</button>
        		{%- endif -%}
        		{%- if (config.ACL.delete|length) == 0 or is_granted(config.ACL.delete) -%}
        		<button type="button" class="uk-button uk-button-danger uk-border-rounded uk-button-small qc-btn-action qc-delete">
        			<span uk-icon="icon: minus-circle"></span>
        		</button>
        		{%- endif -%}
            `},
        ],
        initComplete : function() {
            var input = $('.dataTables_filter input').unbind();
            var self = this.api();
            var $searchButton = $('<button>')
				.attr('class', 'uk-button uk-button-primary uk-button-small uk-border-rounded dt-btn-search')
       			.append('<span uk-icon="icon: search"></span> Search')
       			.click(function() {self.search(input.val()).draw()});

            $('.dataTables_filter input').on('search', function(e){
            	self.search(input.val()).draw();
            })
   			
            $('.dataTables_filter').append($searchButton);
        }
    });

	$("#view tbody").on( "click", "td .qc-view", function(e){
		var row = table.row($(e.currentTarget).parents('tr')).data();
		var path = "{{ path(config.path.form, {action: 'read', id: '0000'}) }}";
		path = path.replace("0000", row.id);
		document.location = path;
	})

	$("#view tbody").on( "click", "td .qc-edit", function(e){
		var row = table.row($(e.currentTarget).parents('tr')).data();
		var path = "{{ path(config.path.form, {action: 'update', id: '0000'}) }}";
		path = path.replace("0000", row.id);
		document.location = path;
	})

	$("#view tbody").on( "click", "td .qc-delete", function(e){
		var row = table.row($(e.currentTarget).parents('tr')).data();
		UIkit.modal.confirm('Are you sure want to delete data {{ config.title }}?').then(function() {
			var path = "{{ path(config.path.remove, {action: 'delete', id: '0000'}) }}";
			path = path.replace("0000", row.id);
			$.get(path, function(data, status){
				if(status === 'success'){
					$("#view").DataTable().ajax.reload();
				}
			});
		}, function(){});
	})
	
});
</script>
{% endblock %}

{% block actionbar %}
{% include '@quick_coding.view/component/actionbar.twig' with {actionbar: config.actionbar} %}
{% endblock %}

{% block body %}
<div class="uk-card uk-card-default uk-border-rounded">
	<div class="uk-card-header uk-border-rounded">
		<h3><b>{{ config.title }}</b></h3>
	</div>
	<div class="uk-card-body">
		<table id="view" class="uk-table uk-table-hover uk-table-striped" style="width:100%">
            <thead>
                <tr>
                    {% for item in config.view.select %}
                    <th>{{ item }}</th>
                    {% endfor %}
                    <th></th>
                </tr>
            </thead>
        </table>
	</div>
</div>
{% endblock %}